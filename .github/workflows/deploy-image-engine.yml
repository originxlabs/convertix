name: Deploy Convertix Image Engine (Production)

on:
  push:
    branches: [ main ]
    paths:
      - services/image-engine/**

permissions:
  id-token: write
  contents: read

concurrency:
  group: convertix-image-engine
  cancel-in-progress: true

env:
  IMAGE_NAME: convertix-image-engine
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_PORT: "7071"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - uses: actions/checkout@v4

      # -----------------------------
      # 2. Azure Login
      # -----------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------
      # 3. Build + Push Image (ACR build)
      # -----------------------------
      - name: Build and push image in ACR
        run: |
          az acr build \
            -r "${{ secrets.ACR_NAME }}" \
            -t "${{ env.IMAGE_NAME }}:latest" \
            -f services/image-engine/Dockerfile \
            .

      # -----------------------------
      # 6. Deploy to App Service
      # -----------------------------
      - name: Ensure Image Engine App Service exists
        run: |
          if ! az webapp show --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" --name "${{ secrets.AZURE_IMAGE_ENGINE_APP_NAME }}" >/dev/null 2>&1; then
            az webapp create \
              --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --plan "${{ secrets.AZURE_APP_SERVICE_PLAN }}" \
              --name "${{ secrets.AZURE_IMAGE_ENGINE_APP_NAME }}" \
              --deployment-container-image-name "$ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest"
          fi

      - name: Configure container settings
        run: |
          az webapp config container set \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_IMAGE_ENGINE_APP_NAME }}" \
            --container-image-name "$ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest" \
            --container-registry-url "https://$ACR_LOGIN_SERVER" \
            --container-registry-user "${{ secrets.ACR_USERNAME }}" \
            --container-registry-password "${{ secrets.ACR_PASSWORD }}"

          az webapp config appsettings set \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_IMAGE_ENGINE_APP_NAME }}" \
            --settings PORT=${{ env.IMAGE_PORT }} WEBSITES_PORT=${{ env.IMAGE_PORT }}

          az webapp restart --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" --name "${{ secrets.AZURE_IMAGE_ENGINE_APP_NAME }}"

      # -----------------------------
      # 7. Wait for health
      # -----------------------------
      - name: Health check
        run: |
          echo "⏳ Waiting for image engine..."
          for i in {1..12}; do
            if curl -fs "${{ secrets.IMAGE_ENGINE_BASE_URL }}/health/tools" >/dev/null; then
              echo "✅ Image Engine is healthy"
              exit 0
            fi
            echo "…still starting ($i)"
            sleep 10
          done
          echo "❌ Image Engine failed to start"
          exit 1
