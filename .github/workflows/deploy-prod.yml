name: Deploy Convertix API (Production)

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

concurrency:
  group: convertix-prod
  cancel-in-progress: true

env:
  DOTNET_VERSION: "8.0.x"
  API_PROJECT: services/api/PdfEditor.Api.csproj
  PUBLISH_DIR: services/api/out
  ZIP_PATH: api.zip
  IMAGE_NAME: convertix-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Azure Login
      # -----------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------
      # 3. Login to ACR
      # -----------------------------
      - name: Docker login to ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login "${{ secrets.ACR_LOGIN_SERVER }}" -u "${{ secrets.ACR_USERNAME }}" --password-stdin

      # -----------------------------
      # 4. Build + Push Image
      # -----------------------------
      - name: Build and push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_REF="${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          docker build -f services/api/Dockerfile -t "$IMAGE_REF" .
          docker push "$IMAGE_REF"
          echo "IMAGE_REF=$IMAGE_REF" >> $GITHUB_ENV

      # -----------------------------
      # 5. Deploy Image to App Service
      # -----------------------------
      - name: Deploy to Azure App Service (Container)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_APP_NAME }}
          images: ${{ env.IMAGE_REF }}

      # -----------------------------
      # 6. Wait for App to be Ready
      # -----------------------------
      - name: Wait for app startup
        run: |
          echo "⏳ Waiting for app to become healthy..."
          for i in {1..12}; do
            if curl -fs "${{ secrets.API_BASE_URL }}/health" >/dev/null; then
              echo "✅ App is up"
              exit 0
            fi
            echo "…still starting ($i)"
            sleep 10
          done
          echo "❌ App did not become healthy in time"
          exit 1

      # -----------------------------
      # 7. Smoke Test (PROD)
      # -----------------------------
      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke.sh
          API_BASE=${{ secrets.API_BASE_URL }} ./scripts/smoke.sh
