name: Deploy Convertix API (Production)

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

concurrency:
  group: convertix-prod
  cancel-in-progress: true

env:
  DOTNET_VERSION: "8.0.x"
  API_PROJECT: services/api/PdfEditor.Api.csproj
  PUBLISH_DIR: services/api/out
  ZIP_PATH: api.zip

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Setup .NET
      # -----------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # -----------------------------
      # 3. Restore + Publish
      # -----------------------------
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}

      - name: Publish API
        run: |
          dotnet clean ${{ env.API_PROJECT }}
          dotnet publish ${{ env.API_PROJECT }} \
            -c Release \
            -o ${{ env.PUBLISH_DIR }}

      # -----------------------------
      # 3b. Add pdfcpu binary
      # -----------------------------
      - name: Download pdfcpu
        run: |
          set -e

          PDFCPU_VERSION="0.8.2"
          PDFCPU_TAR="pdfcpu_${PDFCPU_VERSION}_linux_amd64.tar.gz"
          PDFCPU_URL="https://github.com/pdfcpu/pdfcpu/releases/download/v${PDFCPU_VERSION}/${PDFCPU_TAR}"

          echo "‚¨áÔ∏è Downloading pdfcpu from:"
          echo "$PDFCPU_URL"

          mkdir -p ${{ env.PUBLISH_DIR }}/tools
          curl -fL "$PDFCPU_URL" -o /tmp/pdfcpu.tar.gz

          echo "üì¶ Extracting pdfcpu..."
          tar -xzf /tmp/pdfcpu.tar.gz -C /tmp

          echo "üìÅ Installing binary..."
          cp /tmp/pdfcpu/pdfcpu ${{ env.PUBLISH_DIR }}/tools/pdfcpu
          chmod +x ${{ env.PUBLISH_DIR }}/tools/pdfcpu

          echo "‚úÖ pdfcpu installed:"
          ${{ env.PUBLISH_DIR }}/tools/pdfcpu version


      # -----------------------------
      # 4. Validate Build Output
      # -----------------------------
      - name: Validate publish output
        run: |
          test -f ${{ env.PUBLISH_DIR }}/PdfEditor.Api.dll
          test -f ${{ env.PUBLISH_DIR }}/PdfEditor.Api.runtimeconfig.json
          echo "‚úÖ Build output validated"

      # -----------------------------
      # 5. Create Run-From-Package zip
      # -----------------------------
      - name: Create deployment zip
        run: |
          rm -f ${{ env.ZIP_PATH }}
          cd ${{ env.PUBLISH_DIR }}
          zip -r $GITHUB_WORKSPACE/${{ env.ZIP_PATH }} .
          cd $GITHUB_WORKSPACE
          unzip -l ${{ env.ZIP_PATH }} | head -20

      # -----------------------------
      # 6. Azure Login
      # -----------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------
      # 7. Deploy to App Service
      # -----------------------------
      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_APP_NAME }}
          package: ${{ env.ZIP_PATH }}

      # -----------------------------
      # 8. Wait for App to be Ready
      # -----------------------------
      - name: Wait for app startup
        run: |
          echo "‚è≥ Waiting for app to become healthy..."
          for i in {1..12}; do
            if curl -fs "${{ secrets.API_BASE_URL }}/health" >/dev/null; then
              echo "‚úÖ App is up"
              exit 0
            fi
            echo "‚Ä¶still starting ($i)"
            sleep 10
          done
          echo "‚ùå App did not become healthy in time"
          exit 1

      # -----------------------------
      # 9. Smoke Test (PROD)
      # -----------------------------
      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke.sh
          API_BASE=${{ secrets.API_BASE_URL }} ./scripts/smoke.sh
